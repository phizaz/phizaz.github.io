<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>NodeJS to check whether the file is being written by another process | Konpat’s Record of Struggles</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="NodeJS to check whether the file is being written by another process" />
<meta name="author" content="Konpat Preechakul" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="To me at first, it should have a simple graceful solution, but turned out it has none. I will try to convince you by the following scenario. Writer I have a python writer (to make sure the file will be written by another process rather than the node itself), here is the code: import os import time from functools import partial def copy(a, b): with open(a, &#39;rb&#39;) as r: with open(b, &#39;wb&#39;, 0) as w: for chunk in iter(partial(r.read, 4 * 1024), b&#39;&#39;): w.write(chunk) time.sleep(0.1) Basically, it will write a file by copying chunk by chunk of 4 KB to the destination. I have added some timeout in the code to make the write slower and to emphasize the problem. Reader Now, we expect that the reader must be able to know whether the file is being written by the code above. Things that don’t work fs.access(path, fs.constants.R_OK &amp; fs.constants.W_OK &amp; fs.constants.X_OK, callback) fs.open(path, &#39;r+&#39;, callback) fs.open(path, &#39;a+&#39;, callback) lockfile.lock(path, {}, callback) by using npm install lockfile here. It just cannot lock whether how long. lockfile.lock(path, callback) by using npm install proper-lockfile here. It always can lock. Things that do work Check the file size difference: const aSize = await fileSize(path) await delay(100) const bSize = await fileSize(path) return aSize !== bSize Note: It is not reliable though because you cannot guarantee that the delay you put is enough for any writer. Check whether the file can be moved: const tmp = path + &#39;-tmp&#39; try { await rename(path, tmp) await rename(tmp, path) return false } catch (err) { return true } Conclusion To what I have to be working, try-moving-the-file wins because it is the most reliable !" />
<meta property="og:description" content="To me at first, it should have a simple graceful solution, but turned out it has none. I will try to convince you by the following scenario. Writer I have a python writer (to make sure the file will be written by another process rather than the node itself), here is the code: import os import time from functools import partial def copy(a, b): with open(a, &#39;rb&#39;) as r: with open(b, &#39;wb&#39;, 0) as w: for chunk in iter(partial(r.read, 4 * 1024), b&#39;&#39;): w.write(chunk) time.sleep(0.1) Basically, it will write a file by copying chunk by chunk of 4 KB to the destination. I have added some timeout in the code to make the write slower and to emphasize the problem. Reader Now, we expect that the reader must be able to know whether the file is being written by the code above. Things that don’t work fs.access(path, fs.constants.R_OK &amp; fs.constants.W_OK &amp; fs.constants.X_OK, callback) fs.open(path, &#39;r+&#39;, callback) fs.open(path, &#39;a+&#39;, callback) lockfile.lock(path, {}, callback) by using npm install lockfile here. It just cannot lock whether how long. lockfile.lock(path, callback) by using npm install proper-lockfile here. It always can lock. Things that do work Check the file size difference: const aSize = await fileSize(path) await delay(100) const bSize = await fileSize(path) return aSize !== bSize Note: It is not reliable though because you cannot guarantee that the delay you put is enough for any writer. Check whether the file can be moved: const tmp = path + &#39;-tmp&#39; try { await rename(path, tmp) await rename(tmp, path) return false } catch (err) { return true } Conclusion To what I have to be working, try-moving-the-file wins because it is the most reliable !" />
<link rel="canonical" href="https://blog.konpat.me/dev/2017/06/26/nodejs-to-check-whether-the-file-is-being-written-by-another-process.html" />
<meta property="og:url" content="https://blog.konpat.me/dev/2017/06/26/nodejs-to-check-whether-the-file-is-being-written-by-another-process.html" />
<meta property="og:site_name" content="Konpat’s Record of Struggles" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-06-26T08:34:03+07:00" />
<script type="application/ld+json">
{"datePublished":"2017-06-26T08:34:03+07:00","description":"To me at first, it should have a simple graceful solution, but turned out it has none. I will try to convince you by the following scenario. Writer I have a python writer (to make sure the file will be written by another process rather than the node itself), here is the code: import os import time from functools import partial def copy(a, b): with open(a, &#39;rb&#39;) as r: with open(b, &#39;wb&#39;, 0) as w: for chunk in iter(partial(r.read, 4 * 1024), b&#39;&#39;): w.write(chunk) time.sleep(0.1) Basically, it will write a file by copying chunk by chunk of 4 KB to the destination. I have added some timeout in the code to make the write slower and to emphasize the problem. Reader Now, we expect that the reader must be able to know whether the file is being written by the code above. Things that don’t work fs.access(path, fs.constants.R_OK &amp; fs.constants.W_OK &amp; fs.constants.X_OK, callback) fs.open(path, &#39;r+&#39;, callback) fs.open(path, &#39;a+&#39;, callback) lockfile.lock(path, {}, callback) by using npm install lockfile here. It just cannot lock whether how long. lockfile.lock(path, callback) by using npm install proper-lockfile here. It always can lock. Things that do work Check the file size difference: const aSize = await fileSize(path) await delay(100) const bSize = await fileSize(path) return aSize !== bSize Note: It is not reliable though because you cannot guarantee that the delay you put is enough for any writer. Check whether the file can be moved: const tmp = path + &#39;-tmp&#39; try { await rename(path, tmp) await rename(tmp, path) return false } catch (err) { return true } Conclusion To what I have to be working, try-moving-the-file wins because it is the most reliable !","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.konpat.me/dev/2017/06/26/nodejs-to-check-whether-the-file-is-being-written-by-another-process.html"},"@type":"BlogPosting","author":{"@type":"Person","name":"Konpat Preechakul"},"url":"https://blog.konpat.me/dev/2017/06/26/nodejs-to-check-whether-the-file-is-being-written-by-another-process.html","headline":"NodeJS to check whether the file is being written by another process","dateModified":"2017-06-26T08:34:03+07:00","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://blog.konpat.me/feed.xml" title="Konpat's Record of Struggles" /><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: {
          equationNumbers: {
            autoNumber: "all"
          },
          extensions: ["cancel.js"]
        },
      })
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML' async></script>

</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Konpat&#39;s Record of Struggles</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>
        
        <div class="trigger">
          <!--
            my_page.autogen is populated by the pagination logic for all pages
                            that are automatically created by the gem. Check for non-existence to exclude pagination pages from site.pages iterators
          -->
          
            
          
            
            <a class="page-link" href="/about/">About</a>
            
          
            
          
            
            <a class="page-link" href="/tags/">Tags</a>
            
          
            
          
            
          
            
            <a class="page-link" href="/academic/index.html">Academic</a>
            
          
            
            <a class="page-link" href="/dev/index.html">Dev</a>
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <a class="page-link" href="/me/index.html">Personal</a>
            
          
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">NodeJS to check whether the file is being written by another process</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-06-26T08:34:03+07:00" itemprop="datePublished">Jun 26, 2017
      </time>
      <span>
        
        <a href="/tags/#js"><span class="badge badge-secondary">js</span></a>
        
      </span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>To me at first, it should have a simple graceful solution, but turned out it has none.</p>

<p>I will try to convince you by the following scenario.</p>

<h3 id="writer">Writer</h3>

<p>I have a python writer (to make sure the file will be written by another process rather than the node itself), here is the code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import os
import time
from functools import partial

def copy(a, b):
    with open(a, 'rb') as r:
        with open(b, 'wb', 0) as w:
            for chunk in iter(partial(r.read, 4 * 1024), b''):
                w.write(chunk)
                time.sleep(0.1)
</code></pre></div></div>

<p>Basically, it will write a file by copying chunk by chunk of 4 KB to the destination.</p>

<p>I have added some timeout in the code to make the write slower and to emphasize the problem.</p>

<h3 id="reader">Reader</h3>

<p>Now, we expect that the reader must be able to know whether the file is being written by the code above.</p>

<h4 id="things-that-dont-work">Things that don’t work</h4>

<ol>
  <li><code class="highlighter-rouge">fs.access(path, fs.constants.R_OK &amp; fs.constants.W_OK &amp; fs.constants.X_OK, callback)</code></li>
  <li><code class="highlighter-rouge">fs.open(path, 'r+', callback)</code></li>
  <li><code class="highlighter-rouge">fs.open(path, 'a+', callback)</code></li>
  <li><code class="highlighter-rouge">lockfile.lock(path, {}, callback)</code> by using <code class="highlighter-rouge">npm install lockfile</code> here. It just cannot lock whether how long.</li>
  <li><code class="highlighter-rouge">lockfile.lock(path, callback)</code> by using <code class="highlighter-rouge">npm install proper-lockfile</code> here. It always can lock.</li>
</ol>

<h4 id="things-that-do-work">Things that do work</h4>

<ol>
  <li>Check the file size difference:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> const aSize = await fileSize(path)
 await delay(100)
 const bSize = await fileSize(path)
 return aSize !== bSize
</code></pre></div>    </div>
    <p>Note: It is not reliable though because you cannot guarantee that the <code class="highlighter-rouge">delay</code> you put is enough for any writer.</p>
  </li>
  <li>Check whether the file can be moved:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> const tmp = path + '-tmp'
 try {
     await rename(path, tmp)
     await rename(tmp, path)
     return false
 } catch (err) {
     return true
 }
</code></pre></div>    </div>
  </li>
</ol>

<h4 id="conclusion">Conclusion</h4>

<p>To what I have to be working, <strong>try-moving-the-file</strong> wins because it is the most reliable !</p>

  </div><a class="u-url" href="/dev/2017/06/26/nodejs-to-check-whether-the-file-is-being-written-by-another-process.html" hidden></a>
</article>



      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col one-half">
        <h2 class="footer-heading">Konpat&#39;s Record of Struggles</h2>
        <ul class="contact-list">
          <li class="p-name">Konpat Preechakul</li><li><a class="u-email" href="mailto:the.akita.ta@gmail.com">the.akita.ta@gmail.com</a></li></ul>
      </div>

      <div class="footer-col one-half">
        <p>O thou, I long to rival thy greatest invention, the mind.</p>
      </div>

      <div class="social-links"><ul class="social-media-list"><li><a href="https://www.facebook.com/phizaz" title="phizaz"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#facebook"></use></svg></a></li><li><a href="https://github.com/phizaz" title="phizaz"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a href="https://www.instagram.com/phizaz" title="phizaz"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#instagram"></use></svg></a></li><li><a href="https://twitter.com/phizaz" title="phizaz"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li><li><a href="/feed.xml" title="rss"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg></a></li></ul>
</div>
    </div>

  </div>

</footer></body>

</html>
